name: Release Agent

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:
    inputs:
      tag:
        description: "Release tag (e.g. v1.0.1). Empty = use server/package.json version"
        required: false
        default: ""

permissions:
  contents: write

jobs:
  build-release:
    if: github.actor != 'github-actions[bot]'
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: server/package-lock.json

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "8.0.x"

      - name: Install server deps
        working-directory: server
        run: npm ci

      - name: Resolve tag
        id: tag
        shell: powershell
        run: |
          $ErrorActionPreference = 'Stop'

          $tag = "${{ github.event.inputs.tag }}"
          if (-not $tag) { $tag = "${{ github.ref_name }}" }

          if ($tag -and -not ($tag -match '^v')) { $tag = "v$tag" }

          if (-not $tag -or -not ($tag -match '^v\\d+\\.\\d+\\.\\d+')) {
            if (-not (Test-Path "server/package.json")) { throw "Missing: server/package.json" }
            $ver = (node -p "require('./server/package.json').version").Trim()
            if (-not $ver) { throw "Missing version in server/package.json" }
            $tag = "v$ver"
          }

          "tag=$tag" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append

      - name: Build agent (zip + msi)
        shell: powershell
        run: |
          $domain = "${{ vars.AGENT_DOMAIN }}"
          if (-not $domain) { $domain = "tb.slee.cc" }
          ./scripts/build-agent-msi.ps1 -Domain $domain -Scheme https -Target win-x64 -OutDir release

      - name: Compute SHA256
        shell: powershell
        run: |
          $zip = Get-ChildItem release -Filter "taobao-agent_*_win-x64.zip" | Select-Object -First 1
          $msi = Get-ChildItem release -Filter "taobao-agent_*_win-x64.msi" | Select-Object -First 1
          if (-not $zip) { throw "Missing zip in ./release" }
          if (-not $msi) { throw "Missing msi in ./release" }

          $zipHash = (Get-FileHash -Algorithm SHA256 $zip.FullName).Hash.ToLower()
          Set-Content -Encoding ASCII -Path ($zip.FullName + ".sha256") -Value "$zipHash  $($zip.Name)"

          $msiHash = (Get-FileHash -Algorithm SHA256 $msi.FullName).Hash.ToLower()
          Set-Content -Encoding ASCII -Path ($msi.FullName + ".sha256") -Value "$msiHash  $($msi.Name)"

      - name: Build latest manifest
        shell: powershell
        run: |
          $zip = Get-ChildItem release -Filter "taobao-agent_*_win-x64.zip" | Select-Object -First 1
          $msi = Get-ChildItem release -Filter "taobao-agent_*_win-x64.msi" | Select-Object -First 1
          if (-not $zip) { throw "Missing zip in ./release" }
          if (-not $msi) { throw "Missing msi in ./release" }

          $zipHash = (Get-FileHash -Algorithm SHA256 $zip.FullName).Hash.ToLower()
          $msiHash = (Get-FileHash -Algorithm SHA256 $msi.FullName).Hash.ToLower()

          $tag = "${{ steps.tag.outputs.tag }}"
          $version = ($tag -replace '^v', '')
          if (-not $version) { $version = $tag }

          $repo = "${{ github.repository }}"
          $zipUrl = "https://github.com/$repo/releases/download/$tag/$($zip.Name)"
          $msiUrl = "https://github.com/$repo/releases/download/$tag/$($msi.Name)"

          $manifest = @{
            version     = $version
            publishedAt = (Get-Date).ToUniversalTime().ToString('o')
            zip         = @{ url = $zipUrl; sha256 = $zipHash; size = $zip.Length }
            msi         = @{ url = $msiUrl; sha256 = $msiHash; size = $msi.Length }
          } | ConvertTo-Json -Depth 5

          Set-Content -Encoding UTF8 -Path (Join-Path "release" "agent-latest.json") -Value $manifest

      - name: Publish GitHub Release assets
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.tag.outputs.tag }}
          target_commitish: ${{ github.sha }}
          files: |
            release/agent-latest.json
            release/*.zip
            release/*.msi
            release/*.sha256
