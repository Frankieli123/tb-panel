name: Auto Release Agent

on:
  push:
    branches:
      - main
    paths:
      - server/**
      - tray/**
      - scripts/**
      - installer/**
      - tools/**

permissions:
  contents: write

concurrency:
  group: auto-release-agent
  cancel-in-progress: true

jobs:
  auto-release:
    if: github.actor != 'github-actions[bot]'
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: server/package-lock.json

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "8.0.x"

      - name: Install server deps
        working-directory: server
        run: npm ci

      - name: Prepare version + tag
        id: prepare
        shell: powershell
        run: |
          $ErrorActionPreference = 'Stop'

          if (-not (Test-Path "server/package.json")) { throw "Missing: server/package.json" }

          $current = (node -p "require('./server/package.json').version").Trim()
          $prev = ''
          try {
            $prevRaw = git show "HEAD~1:server/package.json" 2>$null
            if ($LASTEXITCODE -eq 0 -and $prevRaw) {
              $prev = ([string]((($prevRaw | ConvertFrom-Json).version))).Trim()
            }
          } catch {}

          if ($prev -and $prev -ne $current) {
            Write-Host ">> Version already changed: $prev -> $current"
          } else {
            Write-Host ">> Bumping patch version from $current"
            Push-Location server
            npm version patch --no-git-tag-version
            Pop-Location
            $current = (node -p "require('./server/package.json').version").Trim()
          }

          $tag = "v$current"
          while ((git tag --list $tag).Trim()) {
            Write-Host ">> Tag exists ($tag), bumping again"
            Push-Location server
            npm version patch --no-git-tag-version
            Pop-Location
            $current = (node -p "require('./server/package.json').version").Trim()
            $tag = "v$current"
          }

          $dirty = (git status --porcelain).Trim()
          if ($dirty) {
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            git add server/package.json server/package-lock.json
            git commit -m "chore(agent): release $tag"
          }

          $commit = (git rev-parse HEAD).Trim()
          git tag -a $tag -m $tag

          "version=$current" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
          "tag=$tag" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
          "commit=$commit" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append

      - name: Build agent (zip + msi)
        shell: powershell
        run: |
          $domain = "${{ vars.AGENT_DOMAIN }}"
          if (-not $domain) { $domain = "tb.slee.cc" }
          ./scripts/build-agent-msi.ps1 -Domain $domain -Scheme https -Target win-x64 -OutDir release

      - name: Compute SHA256
        shell: powershell
        run: |
          $zip = Get-ChildItem release -Filter "taobao-agent_*_win-x64.zip" | Select-Object -First 1
          $msi = Get-ChildItem release -Filter "taobao-agent_*_win-x64.msi" | Select-Object -First 1
          if (-not $zip) { throw "Missing zip in ./release" }
          if (-not $msi) { throw "Missing msi in ./release" }

          $zipHash = (Get-FileHash -Algorithm SHA256 $zip.FullName).Hash.ToLower()
          Set-Content -Encoding ASCII -Path ($zip.FullName + ".sha256") -Value "$zipHash  $($zip.Name)"

          $msiHash = (Get-FileHash -Algorithm SHA256 $msi.FullName).Hash.ToLower()
          Set-Content -Encoding ASCII -Path ($msi.FullName + ".sha256") -Value "$msiHash  $($msi.Name)"

      - name: Build latest manifest
        shell: powershell
        run: |
          $zip = Get-ChildItem release -Filter "taobao-agent_*_win-x64.zip" | Select-Object -First 1
          $msi = Get-ChildItem release -Filter "taobao-agent_*_win-x64.msi" | Select-Object -First 1
          if (-not $zip) { throw "Missing zip in ./release" }
          if (-not $msi) { throw "Missing msi in ./release" }

          $zipHash = (Get-FileHash -Algorithm SHA256 $zip.FullName).Hash.ToLower()
          $msiHash = (Get-FileHash -Algorithm SHA256 $msi.FullName).Hash.ToLower()

          $tag = "${{ steps.prepare.outputs.tag }}"
          $version = "${{ steps.prepare.outputs.version }}"
          if (-not $tag) { throw "Missing tag output" }
          if (-not $version) { throw "Missing version output" }

          $repo = "${{ github.repository }}"
          $zipUrl = "https://github.com/$repo/releases/download/$tag/$($zip.Name)"
          $msiUrl = "https://github.com/$repo/releases/download/$tag/$($msi.Name)"

          $manifest = @{}
          $manifest.version = $version
          $manifest.publishedAt = (Get-Date).ToUniversalTime().ToString('o')
          $manifest.zip = @{ url = $zipUrl; sha256 = $zipHash; size = $zip.Length }
          $manifest.msi = @{ url = $msiUrl; sha256 = $msiHash; size = $msi.Length }

          Set-Content -Encoding UTF8 -Path (Join-Path "release" "agent-latest.json") -Value ($manifest | ConvertTo-Json -Depth 5)

      - name: Push version commit + tag
        shell: powershell
        run: |
          git push origin HEAD:main
          git push origin "${{ steps.prepare.outputs.tag }}"

      - name: Publish GitHub Release assets
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.prepare.outputs.tag }}
          target_commitish: ${{ steps.prepare.outputs.commit }}
          files: |
            release/agent-latest.json
            release/*.zip
            release/*.msi
            release/*.sha256
