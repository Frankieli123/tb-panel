generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "linux-musl-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// 淘宝账号管理
model TaobaoAccount {
  id          String   @id @default(uuid())
  name        String   // 账号备注名，如"小号1"
  cookies     String   @db.Text // 加密存储的Cookie JSON
  agentId     String?  // 绑定到哪个 Agent（在哪台机器的浏览器上执行自动化）
  userId      String?
  user        SystemUser? @relation(fields: [userId], references: [id], onDelete: SetNull)
  isActive    Boolean  @default(true) // 是否启用
  status      AccountStatus @default(IDLE)
  lastLoginAt DateTime?
  lastErrorAt DateTime?
  lastError   String?  @db.Text
  errorCount  Int      @default(0) // 连续错误次数
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // 关联 - 详情页模式：分配给该账号抓取的商品
  assignedProducts Product[] @relation("AssignedProducts")
  // 关联 - 购物车模式：该账号拥有的商品
  ownedProducts    Product[] @relation("OwnedProducts")
  snapshots        PriceSnapshot[]

  @@index([userId])
  @@map("taobao_accounts")
}

enum AccountStatus {
  IDLE        // 空闲
  RUNNING     // 正在抓取
  CAPTCHA     // 需要验证码
  LOCKED      // 被锁定
  COOLDOWN    // 冷却中
}

// 商品信息
model Product {
  id            String   @id @default(uuid())
  taobaoId      String   // 淘宝商品ID（移除unique，因为多SKU会有多条）
  url           String   // 商品URL
  title         String?  // 商品标题
  imageUrl      String?  // 商品图片
  currentPrice  Decimal? @db.Decimal(10, 2) // 当前到手价
  originalPrice Decimal? @db.Decimal(10, 2) // 原价
  isActive      Boolean  @default(true) // 是否监控中
  lastCheckAt   DateTime?
  lastError     String?
  checkInterval Int      @default(3600) // 检查间隔(秒)，默认1小时
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // 购物车模式新增字段
  skuId         String?  // SKU唯一标识
  skuProperties String?  @db.Text // SKU属性描述 "颜色:红色;尺码:M"
  cartItemId    String?  // 购物车行ID
  monitorMode   String   @default("CART") // "CART"

  // 详情页模式：分配给哪个账号抓取
  accountId     String?
  account       TaobaoAccount? @relation("AssignedProducts", fields: [accountId], references: [id])

  // 购物车模式：绑定到哪个账号的购物车
  ownerAccountId String?
  ownerAccount   TaobaoAccount? @relation("OwnedProducts", fields: [ownerAccountId], references: [id])

  // 关联
  snapshots     PriceSnapshot[]

  // 复合唯一索引：同一账号的同一SKU只能有一条记录
  @@unique([taobaoId, skuId, ownerAccountId])
  @@index([isActive, lastCheckAt])
  @@index([monitorMode])
  @@map("products")
}

// 价格快照（历史记录）
model PriceSnapshot {
  id            String   @id @default(uuid())
  productId     String
  product       Product  @relation(fields: [productId], references: [id], onDelete: Cascade)

  finalPrice    Decimal  @db.Decimal(10, 2) // 到手价
  originalPrice Decimal? @db.Decimal(10, 2) // 原价
  couponInfo    String?  // 优惠券信息
  promotionInfo String?  // 促销信息
  rawData       Json?    // 原始抓取数据

  accountId     String?  // 使用哪个账号抓取的
  account       TaobaoAccount? @relation(fields: [accountId], references: [id])

  capturedAt    DateTime @default(now())

  @@index([productId, capturedAt])
  @@map("price_snapshots")
}

// 通知配置
model NotificationConfig {
  id        String   @id @default(uuid())

  // 邮件
  emailEnabled    Boolean @default(false)
  emailAddress    String?

  // 微信
  wechatEnabled   Boolean @default(false)
  wechatWebhook   String? // Server酱或企业微信Webhook

  // Telegram
  telegramEnabled Boolean @default(false)
  telegramBotToken String?
  telegramChatId   String?

  // 触发条件
  triggerType     TriggerType @default(AMOUNT)
  triggerValue    Decimal @default(10) @db.Decimal(10, 2) // 降价阈值

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("notification_configs")
}

model UserNotificationConfig {
  id     String @id @default(uuid())

  userId String @unique
  user   SystemUser @relation(fields: [userId], references: [id], onDelete: Cascade)

  // 邮件
  emailEnabled Boolean @default(false)
  emailAddress String?

  // 微信
  wechatEnabled Boolean @default(false)
  wechatWebhook String? // Server酱或企业微信Webhook

  // 钉钉
  dingtalkEnabled Boolean @default(false)
  dingtalkWebhook String?

  // 飞书
  feishuEnabled Boolean @default(false)
  feishuWebhook String?

  // 触发条件
  triggerType     TriggerType @default(AMOUNT)
  triggerValue    Decimal @default(10) @db.Decimal(10, 2) // 降价阈值
  notifyOnPriceUp Boolean @default(false) // 价格上调时也发送通知

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("user_notification_configs")
}

enum TriggerType {
  AMOUNT  // 固定金额
  PERCENT // 百分比
}

// 通知记录
model NotificationLog {
  id        String   @id @default(uuid())
  productId String
  channel   String   // email/wechat/telegram
  title     String
  content   String   @db.Text
  success   Boolean
  error     String?
  sentAt    DateTime @default(now())

  @@index([productId, sentAt])
  @@map("notification_logs")
}

// 系统配置
model SystemConfig {
  id        String   @id @default(uuid())
  key       String   @unique
  value     String   @db.Text
  updatedAt DateTime @updatedAt

  @@map("system_configs")
}

// 抓取配置
model ScraperConfig {
  id              String   @id @default(uuid())
  minDelay        Int      @default(60)    // 最小延迟(秒)
  maxDelay        Int      @default(180)   // 最大延迟(秒)
  pollingInterval Int      @default(60)    // 轮询间隔(分钟)
  quietHoursEnabled Boolean @default(false) // 静默时间：不抓取
  quietHoursStart   String  @default("00:00") // HH:mm（本地时区）
  quietHoursEnd     String  @default("00:00") // HH:mm（本地时区）
  updatedAt       DateTime @updatedAt

  @@map("scraper_configs")
}

enum SystemUserRole {
  admin
  operator
}

model SystemUser {
  id           String         @id @default(uuid())
  username     String         @unique
  passwordHash String         @db.Text
  role         SystemUserRole @default(operator)
  preferredAgentId String?
  isActive     Boolean        @default(true)
  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt

  taobaoAccounts TaobaoAccount[]
  sessions     SystemSession[]
  notificationConfig UserNotificationConfig?
  inviteCodesCreated InviteCode[] @relation("InviteCodeCreatedBy")
  inviteCodesUsed    InviteCode[] @relation("InviteCodeUsedBy")

  @@index([preferredAgentId])
  @@map("system_users")
}

model SystemSession {
  id        String     @id @default(uuid())
  tokenHash String     @unique
  csrfToken String
  expiresAt DateTime
  createdAt DateTime   @default(now())
  lastSeenAt DateTime  @default(now())

  userId    String
  user      SystemUser @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, expiresAt])
  @@map("system_sessions")
}

model InviteCode {
  id        String   @id @default(uuid())
  code      String   @unique
  role      SystemUserRole @default(operator)
  isActive  Boolean  @default(true)
  disabledAt DateTime?
  deletedAt DateTime?
  createdAt DateTime @default(now())
  usedAt    DateTime?

  createdById String?
  createdBy   SystemUser? @relation("InviteCodeCreatedBy", fields: [createdById], references: [id], onDelete: SetNull)

  usedById String?
  usedBy   SystemUser? @relation("InviteCodeUsedBy", fields: [usedById], references: [id], onDelete: SetNull)

  @@index([usedAt])
  @@map("invite_codes")
}
