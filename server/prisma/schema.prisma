generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// 淘宝账号管理
model TaobaoAccount {
  id          String   @id @default(uuid())
  name        String   // 账号备注名，如"小号1"
  cookies     String   @db.Text // 加密存储的Cookie JSON
  isActive    Boolean  @default(true) // 是否启用
  status      AccountStatus @default(IDLE)
  lastLoginAt DateTime?
  lastErrorAt DateTime?
  lastError   String?  @db.Text
  errorCount  Int      @default(0) // 连续错误次数
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // 关联
  products    Product[]
  snapshots   PriceSnapshot[]

  @@map("taobao_accounts")
}

enum AccountStatus {
  IDLE        // 空闲
  RUNNING     // 正在抓取
  CAPTCHA     // 需要验证码
  LOCKED      // 被锁定
  COOLDOWN    // 冷却中
}

// 商品信息
model Product {
  id            String   @id @default(uuid())
  taobaoId      String   @unique // 淘宝商品ID
  url           String   // 商品URL
  title         String?  // 商品标题
  imageUrl      String?  // 商品图片
  currentPrice  Decimal? @db.Decimal(10, 2) // 当前到手价
  originalPrice Decimal? @db.Decimal(10, 2) // 原价
  isActive      Boolean  @default(true) // 是否监控中
  lastCheckAt   DateTime?
  lastError     String?
  checkInterval Int      @default(3600) // 检查间隔(秒)，默认1小时
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // 分配给哪个账号抓取
  accountId     String?
  account       TaobaoAccount? @relation(fields: [accountId], references: [id])

  // 关联
  snapshots     PriceSnapshot[]

  @@index([isActive, lastCheckAt])
  @@map("products")
}

// 价格快照（历史记录）
model PriceSnapshot {
  id            String   @id @default(uuid())
  productId     String
  product       Product  @relation(fields: [productId], references: [id], onDelete: Cascade)

  finalPrice    Decimal  @db.Decimal(10, 2) // 到手价
  originalPrice Decimal? @db.Decimal(10, 2) // 原价
  couponInfo    String?  // 优惠券信息
  promotionInfo String?  // 促销信息
  rawData       Json?    // 原始抓取数据

  accountId     String?  // 使用哪个账号抓取的
  account       TaobaoAccount? @relation(fields: [accountId], references: [id])

  capturedAt    DateTime @default(now())

  @@index([productId, capturedAt])
  @@map("price_snapshots")
}

// 通知配置
model NotificationConfig {
  id        String   @id @default(uuid())

  // 邮件
  emailEnabled    Boolean @default(false)
  emailAddress    String?

  // 微信
  wechatEnabled   Boolean @default(false)
  wechatWebhook   String? // Server酱或企业微信Webhook

  // Telegram
  telegramEnabled Boolean @default(false)
  telegramBotToken String?
  telegramChatId   String?

  // 触发条件
  triggerType     TriggerType @default(AMOUNT)
  triggerValue    Decimal @default(10) @db.Decimal(10, 2) // 降价阈值

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("notification_configs")
}

enum TriggerType {
  AMOUNT  // 固定金额
  PERCENT // 百分比
}

// 通知记录
model NotificationLog {
  id        String   @id @default(uuid())
  productId String
  channel   String   // email/wechat/telegram
  title     String
  content   String   @db.Text
  success   Boolean
  error     String?
  sentAt    DateTime @default(now())

  @@index([productId, sentAt])
  @@map("notification_logs")
}

// 系统配置
model SystemConfig {
  id        String   @id @default(uuid())
  key       String   @unique
  value     String   @db.Text
  updatedAt DateTime @updatedAt

  @@map("system_configs")
}

// 抓取配置
model ScraperConfig {
  id              String   @id @default(uuid())
  minDelay        Int      @default(60)    // 最小延迟(秒)
  maxDelay        Int      @default(180)   // 最大延迟(秒)
  pollingInterval Int      @default(60)    // 轮询间隔(分钟)
  updatedAt       DateTime @updatedAt

  @@map("scraper_configs")
}
